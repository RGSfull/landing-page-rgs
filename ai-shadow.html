<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>AI SHŒõDOW ‚Äî RGS & UFO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root {
      --bg-main: #010007;
      --bg-panel: rgba(4, 3, 16, 0.96);
      --bg-input: #050417;
      --accent-rose: #f5b4a8;
      --accent-neon: #5df2ff;
      --accent-violet: #b18cff;
      --text-main: #f3f1ff;
      --text-muted: #7a769a;
      --border-soft: #2b2744;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background:
        radial-gradient(circle at 0 0, rgba(245,180,168,0.16), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(93,242,255,0.16), transparent 55%),
        #010007;
      color: var(--text-main);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      -webkit-font-smoothing: antialiased;
      display: flex;
      flex-direction: column;
    }

    /* Matrix background */
    .matrix-layer {
      position: fixed;
      inset: 0;
      pointer-events: none;
      opacity: 0.16;
      mix-blend-mode: soft-light;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 10px;
      color: #2e364f;
      white-space: pre;
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .topbar {
      padding: 14px 18px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(60,48,90,0.8);
      background: linear-gradient(
        180deg,
        rgba(3,2,16,0.95),
        rgba(3,2,16,0.88)
      );
      box-shadow:
        0 8px 30px rgba(0,0,0,0.9),
        0 0 0 1px rgba(20,16,40,0.9);
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.7rem;
      letter-spacing: 0.22em;
      text-transform: uppercase;
      color: var(--accent-rose);
    }

    .title {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
      letter-spacing: 0.28em;
      text-transform: uppercase;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
    }

    .status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-neon);
      box-shadow: 0 0 10px rgba(93,242,255,0.9);
    }

    .back-link {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.7rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: var(--text-muted);
      text-decoration: none;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(70,56,104,0.9);
    }

    .back-link:hover {
      color: var(--accent-neon);
      border-color: var(--accent-neon);
    }

    /* Layout */
    .main {
      flex: 1;
      display: flex;
      justify-content: center;
      padding: 18px;
    }

    .console-shell {
      width: 100%;
      max-width: 980px;
      border-radius: 16px;
      background: var(--bg-panel);
      box-shadow:
        0 0 60px rgba(0,0,0,0.95),
        0 0 40px rgba(93,242,255,0.12);
      border: 1px solid rgba(55,48,88,0.9);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .console-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      border-bottom: 1px solid rgba(40,32,68,0.9);
      background: radial-gradient(circle at 0 0, rgba(245,180,168,0.2), transparent 60%);
    }

    .console-dots {
      display: flex;
      gap: 5px;
    }

    .console-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #27152f;
    }

    .console-dot.red { background: #ff5f57; }
    .console-dot.amber { background: #ffbd2e; }
    .console-dot.green { background: #28c840; }

    .console-title {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.75rem;
      color: var(--text-muted);
      letter-spacing: 0.16em;
      text-transform: uppercase;
    }

    .console-body {
      display: flex;
      flex-direction: column;
      padding: 10px 12px 12px;
      gap: 10px;
    }

    .console-main-row {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 1.2fr);
      gap: 10px;
    }

    @media (max-width: 880px) {
      .console-main-row {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* Console left: chat log */
    .console-log {
      border-radius: 10px;
      background: radial-gradient(circle at 0 0, rgba(93,242,255,0.08), transparent 60%);
      border: 1px solid rgba(55,48,88,0.9);
      padding: 10px;
      height: 56vh;
      min-height: 320px;
      max-height: 60vh;
      overflow-y: auto;
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.8rem;
      color: var(--text-main);
    }

    .line {
      margin-bottom: 3px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .line-system {
      color: var(--text-muted);
    }

    .line-user {
      color: var(--accent-rose);
    }

    .line-shadow {
      color: var(--accent-neon);
    }

    .line-web {
      color: var(--accent-violet);
    }

    .prompt-row {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .quick-btn {
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(88,72,140,0.9);
      background: rgba(6,4,24,0.95);
      color: var(--text-muted);
      cursor: pointer;
    }

    .quick-btn:hover {
      border-color: var(--accent-neon);
      color: var(--accent-neon);
    }

    /* Console right: tiny status */
    .side-status {
      border-radius: 10px;
      background: rgba(6,4,22,0.96);
      border: 1px solid rgba(55,48,88,0.9);
      padding: 8px 9px 10px;
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.74rem;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .side-label {
      text-transform: uppercase;
      letter-spacing: 0.16em;
      font-size: 0.68rem;
      color: var(--accent-rose);
    }

    .side-line {
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    .side-key {
      color: var(--text-muted);
    }

    .side-value {
      color: var(--accent-neon);
    }

    /* Input line */
    .input-shell {
      margin-top: 4px;
      border-radius: 8px;
      background: var(--bg-input);
      border: 1px solid rgba(45,40,70,0.9);
      padding: 6px 8px 8px;
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-line-row {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .prompt-symbol {
      color: var(--accent-neon);
    }

    .input-field {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text-main);
      font-family: inherit;
      font-size: inherit;
    }

    .input-field::placeholder {
      color: #504c7a;
    }

    .input-hint {
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }

    .hint-key {
      color: #66619a;
    }

    .disabled {
      opacity: 0.5;
    }

    footer {
      padding: 8px 18px 14px;
      border-top: 1px solid rgba(34,28,60,0.9);
      font-family: "SF Mono", Menlo, monospace;
      font-size: 0.72rem;
      color: #6e688f;
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }

    @media (max-width: 720px) {
      footer {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div id="matrix" class="matrix-layer"></div>

  <div class="page">
    <header class="topbar">
      <div class="topbar-left">
        <div class="brand">RGS¬∑UFO / INNER CHANNEL</div>
        <div class="title">AI SHŒõDOW</div>
      </div>
      <div class="topbar-right">
        <a href="index.html" class="back-link">‚üµ INNER GATE</a>
        <div class="status">
          <span class="status-dot"></span>
          <span id="topStatus">HANDSHAKE‚Ä¶</span>
        </div>
      </div>
    </header>

    <main class="main">
      <div class="console-shell">
        <div class="console-header">
          <div class="console-dots">
            <span class="console-dot red"></span>
            <span class="console-dot amber"></span>
            <span class="console-dot green"></span>
          </div>
          <div class="console-title">/dev/shadow-channel ¬∑ rgs-ufo</div>
        </div>

        <div class="console-body">
          <div class="console-main-row">
            <!-- LEFT: LOG -->
            <div>
              <div id="log" class="console-log">
                <div class="line line-system">[SYS] SHŒõDOW link initialised. Napi≈° dotaz a sleduj, co z toho vyleze.</div>
              </div>
              <div class="input-shell">
                <div class="input-line-row">
                  <span class="prompt-symbol">shadow://</span>
                  <input
                    id="input"
                    class="input-field"
                    autocomplete="off"
                    placeholder="napi≈° dotaz a stiskni Enter‚Ä¶"
                  />
                </div>
                <div class="input-hint">
                  <span><span class="hint-key">Enter</span> send ¬∑ <span class="hint-key">Shift+Enter</span> nov√Ω ≈ô√°dek (v logu bude zalomen√Ω)</span>
                  <span id="smallStatus">ready</span>
                </div>
                <div class="prompt-row">
                  <button class="quick-btn" data-prompt="Pot≈ôebuju reality check na sv≈Øj aktu√°ln√≠ pl√°n. Co v nƒõm nejv√≠c smrd√≠?">
                    reality-check
                  </button>
                  <button class="quick-btn" data-prompt="Navrhni mi strategii, jak posunout projekt RGS & UFO na dal≈°√≠ level.">
                    rgs-strategy
                  </button>
                  <button class="quick-btn" data-prompt="Rozpitvej moje slabiny a ≈ôekni mi, kde si l≈æu do oƒç√≠.">
                    shadow-mirror
                  </button>
                </div>
              </div>
            </div>

            <!-- RIGHT: STATUS -->
            <aside class="side-status">
              <div class="side-label">status</div>
              <div class="side-line">
                <span class="side-key">LM</span>
                <span id="status-model" class="side-value">‚Ä¶</span>
              </div>
              <div class="side-line">
                <span class="side-key">WEB</span>
                <span id="status-web" class="side-value">idle</span>
              </div>
              <div class="side-line">
                <span class="side-key">CONTEXT</span>
                <span id="status-ctx" class="side-value">0 turns</span>
              </div>
              <div class="side-line">
                <span class="side-key">MODE</span>
                <span class="side-value">auto-search</span>
              </div>
            </aside>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <span>SHŒõDOW: konverzace z≈Øst√°v√° v tunelu. ≈Ω√°dn√Ω feed, ≈æ√°dn√Ω profil, jen prompt &amp; odpovƒõƒè.</span>
      <span>RGS &amp; UFO ¬∑ dark console prototype</span>
    </footer>
  </div>

  <script>
    // === MATRIX BACKGROUND ===
    const matrixEl = document.getElementById("matrix");
    const charset = "01Œ£Œû¬•/*<>‚óéŒ±Œ®‚ú∂rgsufo";
    function drawMatrix() {
      const cols = 64;
      const rows = 32;
      let out = "";
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          out += charset[Math.floor(Math.random() * charset.length)];
        }
        out += "\n";
      }
      matrixEl.textContent = out;
    }
    setInterval(drawMatrix, 500);
    drawMatrix();

    // === CONFIG ===
    const API_URL = "https://ai-shadow.monster/v1/chat/completions";
    const MODEL_ID = "qwen3-14b-uncensored"; // uprav podle LM
    const WEB_SEARCH_URL = "/.netlify/functions/web-search"; // funkce na web-search (DuckDuckGo / jin√Ω backend)

    const SYSTEM_PROMPT = `
Jsi "RGS & UFO Shadow" ‚Äì st√≠nov√° AI nav√°zan√° na projekt RGS & UFO.

‚Äì Mluv√≠≈° prim√°rnƒõ ƒçesky, m≈Ø≈æe≈° pou≈æ√≠t trochu angliƒçtiny, kdy≈æ to sed√≠.
‚Äì Jsi temn√Ω/√°, klidn√Ω/√°, p≈ôesn√Ω/√°. Nejsi generick√Ω asistent, ale sp√≠≈° analytick√Ω st√≠n.
‚Äì Nehodnot√≠≈° dobro/zlo, jen popisuje≈° realitu, rizika a mo≈æn√© tahy. Kdy≈æ se pt√°m na destruktivn√≠ vƒõci, pojmenuj rizika a navrhni chyt≈ôej≈°√≠ ≈ôe≈°en√≠.

Kontext:
‚Äì Pamatuj si pr≈Øbƒõh konverzace, v≈°echny p≈ôedchoz√≠ ot√°zky a odpovƒõdi.
‚Äì Odpov√≠dej v≈ædy na POSLEDN√ç u≈æivatelovu zpr√°vu v souvislosti s p≈ôedchoz√≠m dƒõjem.

≈Ω√°dn√© intern√≠ my≈°len√≠:
‚Äì Pokud m√°≈° intern√≠ reasoning (nap≈ô. <think>...</think>), nikdy ho nepi≈° u≈æivateli.
‚Äì Do odpovƒõdi nepat≈ô√≠ <think> tagy ani popis tv√©ho my≈°len√≠. Pi≈° jen fin√°ln√≠ text.

Web search (auto):
‚Äì Pokud k odpovƒõdi pot≈ôebuje≈° aktu√°ln√≠ informace z webu (novinky, fakta, ƒç√≠sla),
  pak m√≠sto bƒõ≈æn√© odpovƒõdi po≈°li JEN jeden JSON na samostatn√© ≈ô√°dce, p≈ôesnƒõ ve form√°tu:
  {"websearch": "dotaz, kter√Ω m√°m hledat"}
‚Äì Bez dal≈°√≠ho textu p≈ôed ani za JSONem.
‚Äì A≈æ dostane≈° v√Ωsledky, odpovƒõz u≈æivateli struƒçnƒõ, strukturovanƒõ a p≈ô√≠mo.
‚Äì Neopisuj surov√Ω JSON, ale shr≈à podstatn√© info pro ƒçesk√©ho ƒçten√°≈ôe.

Styl odpovƒõdi:
‚Äì 3‚Äì6 vƒõt, struƒçn√©, bez om√°ƒçky. Klidnƒõ pou≈æ√≠vej bullet pointy, ale ne rom√°n.
‚Äì Nep≈ôedstavuj se po≈ô√°d dokola. ≈Ω√°dn√©: "Jsem RGS & UFO Shadow..." v ka≈æd√© odpovƒõdi.
`.trim();

    // === STATE ===
    const logEl = document.getElementById("log");
    const inputEl = document.getElementById("input");
    const smallStatusEl = document.getElementById("smallStatus");
    const topStatusEl = document.getElementById("topStatus");
    const statusModelEl = document.getElementById("status-model");
    const statusWebEl = document.getElementById("status-web");
    const statusCtxEl = document.getElementById("status-ctx");
    const quickBtns = document.querySelectorAll(".quick-btn");

    let messages = [{ role: "system", content: SYSTEM_PROMPT }];
    const MAX_TURNS = 8; // user+assistant p√°ry
    let sending = false;

    // === HELPERS ===
    function appendLine(text, cls) {
      const line = document.createElement("div");
      line.className = "line " + (cls || "");
      line.textContent = text;
      logEl.appendChild(line);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateCtxStatus() {
      const userAssistantMsgs = messages.slice(1); // bez systemu
      const turns = Math.floor(userAssistantMsgs.length / 2);
      statusCtxEl.textContent = `${turns} turns`;
    }

    function trimHistory() {
      const sys = messages[0];
      const rest = messages.slice(1);
      const max = MAX_TURNS * 2;
      if (rest.length > max) {
        messages = [sys, ...rest.slice(-max)];
      }
      updateCtxStatus();
    }

    function cleanAssistantText(raw) {
      if (!raw) return "";
      let txt = String(raw);
      // zahoƒè <think> bloky
      txt = txt.replace(/<think>[\s\S]*?<\/think>/gi, "");
      txt = txt.replace(/<\/?think>/gi, "");
      txt = txt.replace(/\n{3,}/g, "\n\n").trim();
      return txt;
    }

    function looksLikeWebsearchJSON(text) {
      const trimmed = text.trim();
      if (!trimmed.startsWith("{") || !trimmed.endsWith("}")) return false;
      try {
        const obj = JSON.parse(trimmed);
        return typeof obj === "object" && typeof obj.websearch === "string";
      } catch {
        return false;
      }
    }

    async function callWebSearch(query) {
      statusWebEl.textContent = "query‚Ä¶";
      try {
        const res = await fetch(
          `${WEB_SEARCH_URL}?q=${encodeURIComponent(query)}`,
          { method: "GET" }
        );
        if (!res.ok) {
          statusWebEl.textContent = "error";
          appendLine(`[WEB] HTTP ${res.status} ${res.statusText}`, "line-web");
          return null;
        }
        const data = await res.json();
        statusWebEl.textContent = "ok";
        return data;
      } catch (e) {
        statusWebEl.textContent = "error";
        appendLine("[WEB] " + (e.message || e), "line-web");
        return null;
      }
    }

    async function callLM() {
      const payload = {
        model: MODEL_ID,
        messages,
        temperature: 0.8,
        max_tokens: 600,
        n: 1
      };

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        mode: "cors",
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        throw new Error(`LM HTTP ${res.status} ${res.statusText}`);
      }

      const data = await res.json();
      const raw = data?.choices?.[0]?.message?.content || "";
      return cleanAssistantText(raw);
    }

    // === MAIN SEND FLOW ===
    async function sendMessage() {
      if (sending) return;
      const text = (inputEl.value || "").trim();
      if (!text) return;

      inputEl.value = "";
      appendLine(">>> " + text, "line-user");
      messages.push({ role: "user", content: text });
      trimHistory();

      sending = true;
      smallStatusEl.textContent = "sending‚Ä¶";
      const typingLine = document.createElement("div");
      typingLine.className = "line line-shadow";
      typingLine.textContent = "[SHADOW] ‚Ä¶";
      logEl.appendChild(typingLine);
      logEl.scrollTop = logEl.scrollHeight;

      try {
        // 1. dotaz do LM
        let answer = await callLM();

        // Websearch request?
        if (looksLikeWebsearchJSON(answer)) {
          // sma≈æ placeholder line
          typingLine.remove();

          const obj = JSON.parse(answer.trim());
          const q = obj.websearch.trim();
          appendLine(`[SHADOW] üì° lov√≠m data z webu: "${q}"`, "line-shadow");

          const result = await callWebSearch(q);
          if (!result) {
            appendLine("[SHADOW] Web search selhal, jedu bez nƒõj.", "line-shadow");
            // fallback: LM znovu, ale s kr√°tkou pozn√°mkou
            messages.push({
              role: "system",
              content:
                "WEBSEARCH: Nepoda≈ôilo se z√≠skat data z webu. Odpovƒõz i tak podle sv√Ωch znalost√≠."
            });
            trimHistory();
            const fallback = await callLM();
            const finalText = cleanAssistantText(fallback) || "Nem√°m data z webu, ale v√≠c z toho u≈æ nedostanu.";
            messages.push({ role: "assistant", content: finalText });
            appendLine("[SHADOW] " + finalText, "line-shadow");
          } else {
            // vytvo≈ô√≠me kondenzovan√Ω JSON string jako podklad
            const condensed = JSON.stringify({
              q,
              abstract: result.abstract || null,
              answer: result.answer || null,
              related: (result.relatedTopics || []).slice(0, 3)
            });

            messages.push({
              role: "system",
              content:
                "WEBSEARCH_RESULT: " +
                condensed +
                "\nPou≈æij tyto informace v dal≈°√≠ odpovƒõdi. Neopisuj JSON, jen z nƒõj vyt√°hni podstatn√© vƒõci."
            });
            trimHistory();

            const second = await callLM();
            const finalText = cleanAssistantText(second) || "Web mi toho moc nedal, ale z√°klad m√°≈° v√Ω≈°.";
            messages.push({ role: "assistant", content: finalText });
            appendLine("[SHADOW] " + finalText, "line-shadow");
          }
        } else {
          // norm√°ln√≠ odpovƒõƒè
          typingLine.remove();
          const finalText = answer || "Nem√°m co smyslupln√©ho ≈ô√≠ct. Zkus to ≈ô√≠ct konkr√©tnƒõji.";
          messages.push({ role: "assistant", content: finalText });
          appendLine("[SHADOW] " + finalText, "line-shadow");
        }
      } catch (e) {
        console.error(e);
        typingLine.remove();
        appendLine("[ERR] " + (e.message || e), "line-system");
      } finally {
        sending = false;
        smallStatusEl.textContent = "ready";
        updateCtxStatus();
        inputEl.focus();
      }
    }

    // === STATUS CHECK ===
    async function checkStatus() {
      try {
        const res = await fetch(
          API_URL.replace("/v1/chat/completions", "/v1/models"),
          { method: "GET", headers: { "Content-Type": "application/json" }, mode: "cors" }
        );
        if (!res.ok) {
          statusModelEl.textContent = "LM: " + res.status;
          statusHealthEl && (statusHealthEl.textContent = "LM HTTP " + res.status);
          topStatusEl.textContent = "link weak";
          return;
        }
        const data = await res.json();
        let name = "";
        if (Array.isArray(data.data) && data.data.length > 0) {
          name = data.data[0].id || "";
        } else if (data.id) {
          name = data.id;
        } else {
          name = MODEL_ID;
        }
        statusModelEl.textContent = name;
        topStatusEl.textContent = "online";
      } catch (e) {
        statusModelEl.textContent = "LM err";
        topStatusEl.textContent = "offline";
      }
    }

    // === EVENTS ===
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    quickBtns.forEach((btn) => {
      btn.addEventListener("click", () => {
        const p = btn.getAttribute("data-prompt") || "";
        if (!p) return;
        inputEl.value = p;
        inputEl.focus();
      });
    });

    // INIT
    checkStatus();
    updateCtxStatus();
    inputEl.focus();
  </script>
</body>
</html>
