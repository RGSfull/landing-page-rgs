<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <title>Burn Threads · Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #050816 0, #02010a 45%, #000 100%);
      color: #f5f5f5;
    }
    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 8px;
    }
    .subtitle {
      opacity: 0.8;
      font-size: 0.9rem;
      margin-bottom: 24px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-bottom: 28px;
    }
    .pill {
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .pill-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
    }
    .pill-value {
      font-size: 1.2rem;
      font-weight: 600;
    }
    .pill-tag {
      margin-top: 2px;
      font-size: 0.7rem;
      opacity: 0.7;
    }
    .table-wrap {
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      overflow: hidden;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    thead {
      background: rgba(15, 23, 42, 0.95);
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
      white-space: nowrap;
    }
    th {
      font-weight: 500;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.8;
    }
    td.token {
      font-family: "JetBrains Mono", "SF Mono", ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
    }
    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.94);
    }
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }
    .status-open {
      background: rgba(34, 197, 94, 0.12);
      color: #4ade80;
      border: 1px solid rgba(34, 197, 94, 0.5);
    }
    .status-closed {
      background: rgba(148, 163, 184, 0.15);
      color: #cbd5f5;
      border: 1px solid rgba(148, 163, 184, 0.6);
    }
    .status-escalated {
      background: rgba(248, 113, 113, 0.18);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.7);
    }
    .small {
      font-size: 0.75rem;
      opacity: 0.8;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .toolbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.75rem;
      opacity: 0.8;
    }
    button.refresh {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      cursor: pointer;
      font-size: 0.78rem;
    }
    button.refresh:hover {
      background: rgba(30, 64, 175, 0.8);
      border-color: rgba(129, 140, 248, 0.9);
    }
    .error {
      margin-top: 10px;
      color: #fecaca;
      font-size: 0.8rem;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Burn Threads · Admin</h1>
    <div class="subtitle">rychlý přehled vláken Burn v3 · jen pro Syndikát</div>

    <div class="toolbar">
      <div class="small" id="lastUpdated">nenačteno</div>
      <div class="toolbar-right">
        <button class="refresh" id="refreshBtn">↻ refresh</button>
        <span id="statusText"></span>
      </div>
    </div>

    <div class="stats-grid">
      <div class="pill">
        <div class="pill-label">všechna vlákna</div>
        <div class="pill-value" id="statTotal">–</div>
        <div class="pill-tag">total</div>
      </div>
      <div class="pill">
        <div class="pill-label">otevřená</div>
        <div class="pill-value" id="statOpen">–</div>
        <div class="pill-tag">open</div>
      </div>
      <div class="pill">
        <div class="pill-label">eskalovaná</div>
        <div class="pill-value" id="statEscalated">–</div>
        <div class="pill-tag">escalated</div>
      </div>
      <div class="pill">
        <div class="pill-label">uzavřená / expirovaná</div>
        <div class="pill-value" id="statClosed">–</div>
        <div class="pill-tag">closed</div>
      </div>
      <div class="pill">
        <div class="pill-label">dnes založená</div>
        <div class="pill-value" id="statToday">–</div>
        <div class="pill-tag">today</div>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>vytvořeno</th>
            <th>token</th>
            <th>msg</th>
            <th>stav</th>
            <th>TTL</th>
          </tr>
        </thead>
        <tbody id="threadsBody">
        </tbody>
      </table>
    </div>

    <div class="error" id="errorBox"></div>
  </div>

  <script>
    const statTotal = document.getElementById("statTotal");
    const statOpen = document.getElementById("statOpen");
    const statEscalated = document.getElementById("statEscalated");
    const statClosed = document.getElementById("statClosed");
    const statToday = document.getElementById("statToday");
    const threadsBody = document.getElementById("threadsBody");
    const statusText = document.getElementById("statusText");
    const lastUpdated = document.getElementById("lastUpdated");
    const errorBox = document.getElementById("errorBox");
    const refreshBtn = document.getElementById("refreshBtn");

    let adminKey = null;

    function formatTs(ts) {
      if (!ts) return "–";
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return ts;
      return d.toLocaleString("cs-CZ", {
        year: "2-digit",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit"
      });
    }

    function formatTtl(expiresAt) {
      if (!expiresAt) return "–";
      const now = Date.now();
      const exp = new Date(expiresAt).getTime();
      if (Number.isNaN(exp)) return "–";
      const diff = exp - now;
      if (diff <= 0) return "expired";
      const mins = Math.round(diff / 60000);
      return mins + " min";
    }

    function renderStatus(thread) {
      const now = new Date();
      const exp = new Date(thread.expires_at);
      const isExpired = exp <= now;
      const isClosed = thread.closed_at !== null || isExpired;

      if (thread.escalated) return { cls: "status-escalated", label: "escalated" };
      if (!isClosed) return { cls: "status-open", label: "open" };
      return { cls: "status-closed", label: "closed" };
    }

    async function loadAdminData() {
      if (!adminKey) {
        adminKey = window.prompt("RGS_ADMIN_KEY?");
        if (!adminKey) {
          statusText.textContent = "bez klíče se nikam nejede";
          return;
        }
      }

      statusText.textContent = "načítám…";
      errorBox.textContent = "";

      try {
        const url = new URL("/.netlify/functions/burn-threads-admin", window.location.origin);
        url.searchParams.set("key", adminKey);
        const res = await fetch(url.toString());
        if (res.status === 401) {
          statusText.textContent = "špatný RGS_ADMIN_KEY";
          errorBox.textContent = "backend odmítl přístup – zkontroluj klíč";
          adminKey = null;
          return;
        }
        if (!res.ok) {
          statusText.textContent = "chyba při načítání";
          errorBox.textContent = "server vrátil " + res.status;
          return;
        }
        const data = await res.json();
        if (!data.ok) {
          statusText.textContent = "backend řekl ne";
          errorBox.textContent = data.error || "neznámá chyba";
          return;
        }

        const s = data.stats || {};
        statTotal.textContent = s.total ?? 0;
        statOpen.textContent = s.open ?? 0;
        statEscalated.textContent = s.escalated ?? 0;
        statClosed.textContent = s.closed ?? 0;
        statToday.textContent = s.today ?? 0;

        threadsBody.innerHTML = "";
        (data.threads || []).forEach(t => {
          const tr = document.createElement("tr");

          const tdCreated = document.createElement("td");
          tdCreated.textContent = formatTs(t.created_at);
          tr.appendChild(tdCreated);

          const tdToken = document.createElement("td");
          tdToken.className = "token";
          tdToken.textContent = t.token;
          tr.appendChild(tdToken);

          const tdMsg = document.createElement("td");
          tdMsg.textContent = t.message_count;
          tr.appendChild(tdMsg);

          const tdStatus = document.createElement("td");
          const st = renderStatus(t);
          const span = document.createElement("span");
          span.className = "status-pill " + st.cls;
          span.textContent = st.label;
          tdStatus.appendChild(span);
          tr.appendChild(tdStatus);

          const tdTtl = document.createElement("td");
          tdTtl.textContent = formatTtl(t.expires_at);
          tr.appendChild(tdTtl);

          threadsBody.appendChild(tr);
        });

        statusText.textContent = "OK";
        lastUpdated.textContent = "naposledy: " + new Date().toLocaleTimeString("cs-CZ");
      } catch (e) {
        console.error("burn-admin load error", e);
        statusText.textContent = "network error";
        errorBox.textContent = "volání backendu selhalo – zkontroluj konzoli";
      }
    }

    refreshBtn.addEventListener("click", () => {
      loadAdminData();
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadAdminData();
    });
  </script>
</body>
</html>
